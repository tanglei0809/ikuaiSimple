<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>动态表单 - 路由器白名单IP管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <meta name="referrer" content="origin">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        success: '#10b981',
                        error: '#ef4444',
                        neutral: '#64748b'
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .input-focus {
                @apply focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none transition-all duration-200;
            }

            .btn-hover {
                @apply hover:shadow-md hover:-translate-y-0.5 transition-all duration-300;
            }

            .form-field {
                @apply w-full px-4 py-2 border border-gray-300 rounded-lg input-focus;
            }

            .form-group {
                @apply flex flex-col space-y-2 mb-5;
            }

            .password-wrapper {
                @apply relative;
            }

            .password-toggle {
                @apply absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-primary cursor-pointer transition-colors duration-200;
            }
        }
    </style>

    <style>
        /* 加载动画 */
        .loader {
            border-top-color: #2563eb;
            animation: spinner 0.8s linear infinite;
        }

        @keyframes spinner {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* 平滑滚动 */
        html {
            scroll-behavior: smooth;
        }

        /* 防止表单提交时页面抖动 */
        button:disabled {
            cursor: not-allowed !important;
        }

        /* 数据加载提示 */
        .echo-loading {
            color: #2563eb;
            font-size: 12px;
            text-align: center;
            padding: 8px 0;
        }

        /* 未配置提示 */
        .no-echo-data {
            color: #64748b;
            font-size: 12px;
            text-align: center;
            padding: 8px 0;
        }

        /* 新增：IP段提示样式 */
        .ip-tip {
            font-size: 11px;
            color: #64748b;
            margin-top: -8px;
        }

        /* 新增：端口映射列表样式 */
        .dst-nat-list {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            overflow: visible !important;
        }

        .dst-nat-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }

        .dst-nat-item:hover {
            background-color: #f9fafb;
        }

        .dst-nat-item:last-child {
            border-bottom: none;
        }

        .dst-nat-checkbox {
            margin-right: 0.75rem;
        }

        .dst-nat-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* 优化分组下拉框样式 */
        .dst-nat-group-dropdown {
            font-size: 13px !important;
            padding: 3px 6px !important;
            min-height: 28px;
        }

        .dst-nat-selected-text {
            font-size: 13px !important;
            max-width: 180px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dst-nat-dropdown-menu {
            font-size: 13px !important;
            z-index: 9999 !important;
            position: absolute !important;
            max-height: 200px !important;
            min-width: 100% !important;
            left: 0 !important;
            top: 100% !important;
        }

        .dst-nat-dropdown-menu label {
            font-size: 13px !important;
        }

        .dst-nat-lan-addr {
            color: #6b7280;
            font-size: 0.875rem;
            white-space: nowrap;
        }

        .dst-nat-src-addr {
            color: #059669;
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
            border-bottom: 1px dotted #059669;
            cursor: help;
        }

        .dst-nat-details {
            font-size: 0.875rem;
            color: #6b7280;
            white-space: nowrap;
        }

        /* Tooltip样式 - 修复无法超出列表框的问题 */
        .tooltip {
            position: relative;
            display: inline-block;
            /* 确保tooltip容器不会被裁剪 */
            overflow: visible !important;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            position: fixed; /* 使用fixed定位避免被父元素裁剪 */
            z-index: 9999; /* 提高层级确保显示在最上层 */
            bottom: auto;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            max-width: 400px;
            word-wrap: break-word;
            white-space: normal;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .dst-nat-summary {
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 0.375rem;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dst-nat-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 font-sans text-gray-800">
<header class="bg-white shadow-sm py-4 px-6 sticky top-0 z-10">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
        <h1 class="text-xl font-bold flex items-center">
            <i class="fa fa-cogs text-primary mr-2"></i>路由器白名单IP管理
        </h1>
        <div class="flex gap-3">
            <button type="button" id="downloadBtn"
                    class="bg-blue-600 text-white font-medium py-1.5 px-3 rounded-lg btn-hover flex items-center justify-center text-sm disabled:opacity-70 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none">
                <i class="fa fa-download mr-1"></i>
                <span>下载配置</span>
                <div class="hidden ml-1 loader w-3 h-3 border-2 border-white border-t-transparent rounded-full"></div>
            </button>
            <button type="button" id="uploadBtn"
                    class="bg-green-600 text-white font-medium py-1.5 px-3 rounded-lg btn-hover flex items-center justify-center text-sm disabled:opacity-70 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none">
                <i class="fa fa-upload mr-1"></i>
                <span>上传配置</span>
                <div class="hidden ml-1 loader w-3 h-3 border-2 border-white border-t-transparent rounded-full"></div>
            </button>
        </div>
    </div>
</header>

<div id="toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 hidden transition-all duration-300 ease-in-out">
    <div class="flex items-center px-4 py-3 rounded-lg shadow-lg max-w-sm w-full">
        <div id="toastIcon" class="mr-3 text-lg"></div>
        <div id="toastMessage" class="text-sm font-medium flex-1"></div>
    </div>
</div>

<main class="max-w-7xl mx-auto px-4 py-8 flex flex-col md:flex-row items-start gap-6">
    <div class="md:w-64 shrink-0 bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition-shadow duration-300 h-fit">
        <h3 class="text-md font-semibold mb-4 pb-2 border-b border-gray-100 flex items-center">
            <i class="fa fa-info-circle text-primary mr-2"></i>使用说明
        </h3>
        <ul class="text-sm text-gray-700 space-y-3">
            <li class="flex items-start">
                <span class="text-primary font-medium mr-2">1.</span>
                <span>本功能是给爱快端口映射添加IP白名单,只允许公网映射端口被国内ip访问</span>
            </li>
            <li class="flex items-start">
                <span class="text-primary font-medium mr-2">2.</span>
                <span>默认每三天自动执行一次IP列表更新,请注意备份</span>
            </li>
            <li class="flex items-start">
                <span class="text-primary font-medium mr-2">3.</span>
                <span>获取的国内IP地址数据来源于ipdeny</span>
            </li>
            <li class="flex items-start">
                <span class="text-primary font-medium mr-2">4.</span>
                <span>目前仅支持ikuai</span>
            </li>
            <li class="flex items-start text-neutral">
                <i class="fa fa-lightbulb-o mr-2 mt-0.5"></i>
                <span>勾选立即执行后会立即覆盖原有配置，请注意爱快备份</span>
            </li>
            <li class="flex items-start text-neutral">
                <i class="fa fa-clock-o mr-2 mt-0.5"></i>
                <span>未勾选立即执行时，配置仅保存，系统每3天自动执行一次更新</span>
            </li>
            <li class="flex items-start text-neutral">
                <i class="fa fa-globe mr-2 mt-0.5"></i>
                <span>支持IP段格式（如192.168.1.0/24），每行一条数据</span>
            </li>
            <li class="flex items-start text-neutral">
                <i class="fa fa-globe mr-2 mt-0.5"></i>
                <span>设备地址支持IP、域名+端口（如router.ikuai.com:8080）格式</span>
            </li>
            <li class="flex items-start text-neutral">
                <i class="fa fa-link mr-2 mt-0.5"></i>
                <span>URL地址支持http/https开头，每行一条</span>
            </li>
            <li class="flex items-start text-neutral">
                <i class="fa fa-list-alt mr-2 mt-0.5"></i>
                <span>可通过"获取端口映射列表"按钮获取并选择需要配置的端口映射规则</span>
            </li>
        </ul>
    </div>

    <div class="flex-1 max-w-2xl mx-auto bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition-shadow duration-300">
        <h2 class="text-lg font-semibold mb-6 pb-2 border-b border-gray-100">选择类型并提交数据</h2>

        <form id="dynamicForm" class="space-y-6">
            <div class="form-group">
                <label for="routerType" class="text-sm font-medium text-gray-700">
                    路由器类型 <span class="text-error">*</span>
                </label>
                <select id="routerType" class="form-field" required>
                    <option value="" disabled>请选择路由器类型</option>
                    <option value="ikuai" selected>ikuai</option>
                </select>
                <p class="hidden text-error text-xs mt-1" id="errorRouterType">请选择路由器类型</p>
            </div>

            <div id="formFields" class="border rounded-lg p-4 bg-gray-50 min-h-[200px]">
                <div class="echo-loading">
                    <i class="fa fa-spinner fa-spin mr-1"></i> 加载历史配置中...
                </div>
            </div>

            <div id="dstNatListSection" class="hidden border rounded-lg p-4 bg-gray-50">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-md font-semibold">端口映射列表</h3>
                    <button type="button" id="getDstNatListBtn"
                            class="bg-primary text-white font-medium py-1.5 px-3 rounded-lg btn-hover flex items-center justify-center text-sm disabled:opacity-70 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none">
                        <i class="fa fa-refresh mr-1"></i>
                        <span>获取列表</span>
                        <div class="hidden ml-1 loader w-3 h-3 border-2 border-white border-t-transparent rounded-full"></div>
                    </button>
                </div>

                <div id="dstNatListContainer" class="hidden">
                    <div id="dstNatSummary" class="dst-nat-summary hidden">
                        <div class="flex items-start justify-between w-full">
                            <div class="flex-1">
                                <div class="flex items-center">
                                    <button type="button" id="toggleSelectAllBtn" class="btn-small bg-primary text-white mr-3">
                                        <i class="fa fa-check-square-o"></i>
                                        <span>全选</span>
                                    </button>
                                    <span>已选择 <span id="selectedCount">0</span> 项</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1 max-w-[240px] leading-relaxed">提示：选中则只执行选中的数据，默认不选执行所有</p>
                            </div>
                            <div class="dst-nat-actions">
                                <div class="text-right">
                                    <button type="button" id="batchUpdateGroupsBtn" class="btn-small bg-green-600 text-white">
                                        <i class="fa fa-save"></i>
                                        <span>批量设置分组</span>
                                        <div class="hidden ml-1 loader w-3 h-3 border-2 border-white border-t-transparent rounded-full"></div>
                                    </button>
                                    <p class="text-xs text-gray-500 mt-1 max-w-[240px] leading-relaxed">独立功能,实时修改端口映射选中的允许访问ip分组</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="dstNatGroups" class="space-y-2">
                    </div>

                    <div id="dstNatLoading" class="echo-loading hidden">
                        <i class="fa fa-spinner fa-spin mr-1"></i> 获取端口映射列表中...
                    </div>

                    <div id="dstNatEmpty" class="text-center py-8 text-gray-500 hidden">
                        <i class="fa fa-inbox fa-3x mb-2"></i>
                        <p>暂无端口映射规则</p>
                    </div>

                    <div id="dstNatError" class="text-center py-8 text-error hidden">
                        <i class="fa fa-exclamation-circle fa-3x mb-2"></i>
                        <p id="dstNatErrorMessage">获取端口映射列表失败</p>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium text-gray-700 flex items-center cursor-pointer">
                        <input type="checkbox" id="isExecute"
                               class="w-4 h-4 text-primary rounded border-gray-300 focus:ring-primary mr-2" checked>
                        立即执行白名单操作
                    </label>
                    <label class="text-sm font-medium text-gray-700 flex items-center cursor-pointer">
                        <input type="checkbox" id="deleteFlag" checked
                               class="w-4 h-4 text-primary rounded border-gray-300 focus:ring-primary mr-2">
                        删除原有分组
                    </label>
                </div>
                <div class="text-neutral text-xs mt-1">
                    <p>提示：勾选立即执行后提交即执行，取消则仅保存配置，系统每3天自动更新一次</p>
                    <p>提示：勾选删除原有分组后将删除原有白名单分组，仅保留本次配置的IP地址</p>
                </div>
            </div>

            <div class="flex gap-3 mb-4">
                <button type="submit" id="submitBtn"
                        class="flex-1 bg-primary text-white font-medium py-2.5 px-6 rounded-lg btn-hover flex items-center justify-center disabled:opacity-70 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none">
                    <i class="fa fa-paper-plane mr-2"></i>
                    <span>提交</span>
                    <div class="hidden ml-2 loader w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div>
                </button>
                <button type="reset"
                        class="flex-1 bg-gray-100 text-gray-700 border border-gray-300 font-medium py-2.5 px-6 rounded-lg btn-hover flex items-center justify-center">
                    <i class="fa fa-refresh mr-2"></i>
                    <span>重置</span>
                </button>
            </div>

            <input type="file" id="fileInput" accept=".json,.txt" class="hidden">


        </form>
    </div>
</main>

<script>
    // 工具函数：防抖
    const debounce = (fn, delay = 300) => {
        let timer = null;
        return (...args) => {
            clearTimeout(timer);
            timer = setTimeout(() => fn.apply(this, args), delay);
        };
    };

    // 核心配置 - 动态推导接口地址，适配任意前端访问地址
    const getApiBaseUrl = () => {
        // 优先从URL参数获取后端地址（如 ?apiHost=192.168.1.100），适配灵活部署
        const urlParams = new URLSearchParams(window.location.search);
        const apiHost = urlParams.get('apiHost');
        const apiPort = urlParams.get('apiPort') || '8056';

        if (apiHost) {
            // 手动指定后端地址（如 http://192.168.1.100:8056）
            return `${window.location.protocol}//${apiHost}:${apiPort}`;
        }

        // 默认：基于当前页面的协议+域名+固定端口8056
        return `${window.location.protocol}//${window.location.hostname}:${apiPort}`;
    };

    // 核心配置 - 抽离常量便于维护
    const CONFIG = {
        API_URL: `${getApiBaseUrl()}/api/ikuai/submitDynamicForm`,
        ECHO_API_URL: `${getApiBaseUrl()}/api/ikuai/echo`, // echo接口地址
        DST_NAT_LIST_API_URL: `${getApiBaseUrl()}/api/ikuai/getDstNatList`, // 新增：获取端口映射列表接口
        UPDATE_DST_NAT_LIST_API_URL: `${getApiBaseUrl()}/api/ikuai/updateDstNatList`, // 新增：批量更新端口映射分组接口
        UPLOAD_API_URL: `${getApiBaseUrl()}/api/ikuai/upload`, // 新增：上传配置接口
        DOWNLOAD_API_URL: `${getApiBaseUrl()}/api/ikuai/download`, // 新增：下载配置接口
        FORM_FIELDS: {
            ikuai: [
                {
                    id: 'userName',
                    label: '用户名',
                    type: 'text',
                    required: true,
                    placeholder: '请输入ikuai用户名',
                    errorMsg: '用户名不能为空'
                },
                {
                    id: 'password',
                    label: '密码',
                    type: 'password',
                    required: true,
                    placeholder: '请输入ikuai密码（至少6位）',
                    errorMsg: '密码不能为空（至少6位）',
                    validator: v => v.length >= 6
                },
                {
                    id: 'ikuaiIp',
                    label: '设备地址',
                    type: 'text',
                    required: true,
                    placeholder: '请输入ikuai设备地址（例如:192.168.1.1、router.ikuai.com或router.ikuai.com:8080）',
                    errorMsg: '设备地址格式不正确（支持IP、域名、域名+端口）',
                    // 优化验证器：支持IP、域名、域名+端口格式
                    validator: v => {
                        // 移除http/https前缀
                        const cleanValue = v.replace(/^(http|https):\/\/|\/.*$/g, '').trim();
                        if (!cleanValue) return false;

                        // 拆分主机和端口（支持:端口后缀）
                        const [host, port] = cleanValue.split(':');

                        // 验证端口（如果有）
                        if (port) {
                            const portNum = parseInt(port, 10);
                            if (isNaN(portNum) || portNum < 1 || portNum > 65535) {
                                return false;
                            }
                        }

                        // 验证主机部分（IP或域名）
                        // IP正则
                        const ipRegex = /^((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)\.){3}(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)$/;
                        // 域名正则（兼容字母、数字、短横线、多级域名）
                        const domainRegex = /^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;

                        return ipRegex.test(host) || domainRegex.test(host);
                    }
                },
                {
                    id: 'blockAddress',
                    label: '允许访问IP列表',
                    type: 'textarea',
                    required: false,  // 非必填
                    placeholder: '允许访问的IP地址，每行一条（非必填,例如:127.0.0.1/24）',
                    errorMsg: 'IP地址/IP段格式不正确',
                    // 优化验证器：支持IP段（如192.168.1.0/24）
                    validator: v => {
                        // 空值直接通过验证
                        if (!v) return true;
                        // 有值时验证每个IP/IP段格式（仅按换行符分割，每行一条）
                        const ips = v.split('\n').map(ip => ip.trim()).filter(ip => ip);
                        // 支持纯IP和IP段格式
                        const ipWithCidrRegex = /^((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)\.){3}(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\/([0-9]|[1-2][0-9]|3[0-2]))?$/;
                        return ips.every(ip => {
                            const cleanIp = ip.replace(/^(http|https):\/\/|\/.*$/g, '').trim();
                            return ipWithCidrRegex.test(cleanIp);
                        });
                    }
                },
                {
                    id: 'getIpUrls',
                    label: '允许访问的URL列表',
                    type: 'textarea',
                    required: false,  // 非必填
                    placeholder: '允许访问的URL地址，每行一条（非必填,例如:https://example.com）',
                    errorMsg: 'URL格式不正确',
                    // 验证器：支持URL格式
                    validator: v => {
                        // 空值直接通过验证
                        if (!v) return true;
                        // 有值时验证每个URL格式（仅按换行符分割，每行一条）
                        const urls = v.split('\n').map(url => url.trim()).filter(url => url);
                        // 支持URL格式（http/https开头）
                        const urlRegex = /^(https?:\/\/)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)$/;
                        return urls.every(url => urlRegex.test(url));
                    }
                }
            ]
        },
        TIMEOUT: 15000, // 延长超时时间到15秒，适配网络波动
        MESSAGE_DURATION: 6000 // 延长提示显示时间到6秒，确保用户看清
    };

    // DOM元素缓存 - 使用对象字面量更清晰
    const elements = {
        form: document.getElementById('dynamicForm'),
        routerType: document.getElementById('routerType'),
        formFields: document.getElementById('formFields'),
        submitBtn: document.getElementById('submitBtn'),
        uploadBtn: document.getElementById('uploadBtn'),
        downloadBtn: document.getElementById('downloadBtn'),
        fileInput: document.getElementById('fileInput'),
        result: document.getElementById('result'),
        loader: document.querySelector('.loader'),
        errorRouterType: document.getElementById('errorRouterType'),
        isExecute: document.getElementById('isExecute'),
        deleteFlag: document.getElementById('deleteFlag'),
        // 新增：端口映射相关元素
        dstNatListSection: document.getElementById('dstNatListSection'),
        getDstNatListBtn: document.getElementById('getDstNatListBtn'),
        dstNatListContainer: document.getElementById('dstNatListContainer'),
        dstNatSummary: document.getElementById('dstNatSummary'),
        selectedCount: document.getElementById('selectedCount'),
        toggleSelectAllBtn: document.getElementById('toggleSelectAllBtn'),
        batchUpdateGroupsBtn: document.getElementById('batchUpdateGroupsBtn'),
        dstNatGroups: document.getElementById('dstNatGroups'),
        dstNatLoading: document.getElementById('dstNatLoading'),
        dstNatEmpty: document.getElementById('dstNatEmpty'),
        dstNatError: document.getElementById('dstNatError'),
        dstNatErrorMessage: document.getElementById('dstNatErrorMessage')
    };

    // 存储已选中的端口映射ID
    let selectedDstNatIds = new Set();
    // 存储所有端口映射数据
    let dstNatData = [];
    // 存储所有分组数据
    let allGroups = [];
    // 存储每个端口映射项的分组选择状态
    let dstNatGroupSelections = new Map();

    /**
     * 切换密码显示/隐藏状态
     * @param {HTMLElement} toggleBtn - 切换按钮元素
     */
    const togglePasswordVisibility = (toggleBtn) => {
        const passwordInput = toggleBtn.previousElementSibling;
        if (!passwordInput) return;

        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);

        // 切换图标
        if (type === 'text') {
            toggleBtn.classList.remove('fa-eye');
            toggleBtn.classList.add('fa-eye-slash');
            toggleBtn.setAttribute('title', '隐藏密码');
        } else {
            toggleBtn.classList.remove('fa-eye-slash');
            toggleBtn.classList.add('fa-eye');
            toggleBtn.setAttribute('title', '显示密码');
        }
    };

    /**
     * 清理设备地址前缀（移除http/https，保留域名+端口）
     * @param {string} address - 原始设备地址
     * @returns {string} 清理后的地址
     */
    const cleanDeviceAddress = (address) => {
        if (!address) return '';
        // 只移除http/https前缀，保留域名+端口
        return address.replace(/^(http|https):\/\//g, '').trim();
    };

    /**
     * 显示顶部弹窗提示
     * @param {boolean} isSuccess - 是否成功
     * @param {string} message - 提示信息
     */
    const showResult = (isSuccess, message) => {
        const toast = document.getElementById('toast');
        const toastIcon = document.getElementById('toastIcon');
        const toastMessage = document.getElementById('toastMessage');

        if (!toast || !toastIcon || !toastMessage) return;

        // 设置图标和消息
        toastIcon.className = `mr-3 text-lg ${isSuccess ? 'text-green-500' : 'text-red-500'}`;
        toastIcon.innerHTML = `<i class="fa ${isSuccess ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>`;
        toastMessage.textContent = message;

        // 设置背景色
        const toastContent = toast.querySelector('div');
        toastContent.className = `flex items-center px-4 py-3 rounded-lg shadow-lg max-w-sm w-full transition-all duration-300 ${
            isSuccess ? 'bg-white border-l-4 border-green-500' : 'bg-white border-l-4 border-red-500'
        }`;

        // 显示弹窗
        toast.classList.remove('hidden');
        toast.classList.add('opacity-0', 'translate-y-[-20px]');

        // 触发动画
        setTimeout(() => {
            toast.classList.remove('opacity-0', 'translate-y-[-20px]');
            toast.classList.add('opacity-100', 'translate-y-0');
        }, 10);

        // 使用clearTimeout防止多次触发
        if (showResult.timer) clearTimeout(showResult.timer);

        // 自动隐藏
        showResult.timer = setTimeout(() => {
            toast.classList.remove('opacity-100', 'translate-y-0');
            toast.classList.add('opacity-0', 'translate-y-[-20px]');

            // 等待动画完成后完全隐藏
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 300);
        }, CONFIG.MESSAGE_DURATION);
    };

    /**
     * 获取字段值（适配设备地址清理逻辑）
     * @param {object} field - 字段配置
     * @returns {string|number} 字段值
     */
    const getFieldValue = (field) => {
        const el = document.getElementById(field.id);
        if (!el) return '';

        let value = el.value.trim();
        // 对设备地址清理http/https前缀（保留域名+端口）
        if (field.id === 'ikuaiIp') {
            value = cleanDeviceAddress(value);
        }
        if (field.type === 'number') {
            const num = Number(value);
            return isNaN(num) ? '' : num;
        }
        return value;
    };

    /**
     * 设置字段值（用于回显，避免XSS风险）
     * @param {object} field - 字段配置
     * @param {string} value - 要设置的值
     */
    const setFieldValue = (field, value) => {
        const el = document.getElementById(field.id);
        if (!el) return;
        // 安全赋值，避免XSS
        el.value = value || '';
    };

    /**
     * 验证单个字段
     * @param {object} field - 字段配置
     * @returns {boolean} 验证结果
     */
    const validateField = (field) => {
        const el = document.getElementById(field.id);
        const errorEl = document.getElementById(`error-${field.id}`);
        if (!el || !errorEl) return false;

        const value = getFieldValue(field);
        errorEl.classList.add('hidden');

        // 必填项验证（仅当required为true时）
        if (field.required && !value) {
            errorEl.classList.remove('hidden');
            return false;
        }

        // 自定义验证器：仅在有值时验证
        if (field.validator && value && !field.validator(el.value)) { // 传入原始值用于验证
            errorEl.classList.remove('hidden');
            return false;
        }

        return true;
    };

    /**
     * 渲染表单字段
     * @param {string} type - 路由器类型
     * @param {object} echoData - 回显数据（可选）
     */
    const renderFields = (type, echoData = {}) => {
        if (!type) {
            elements.formFields.innerHTML = '<p class="text-neutral text-sm text-center py-6">请先选择路由器类型</p>';
            return;
        }

        const fields = CONFIG.FORM_FIELDS[type] || [];
        let html = '';

        fields.forEach(field => {
            // 输入框/文本域模板
            let inputHtml = '';

            if (field.type === 'textarea') {
                inputHtml = `
                    <textarea id="${field.id}" class="form-field" placeholder="${field.placeholder}" rows="4"></textarea>
                    <p class="ip-tip">支持格式：${field.id === 'getIpUrls' ? 'https://example.com' : '192.168.1.1 或 192.168.1.0/24'}，每行一条数据</p>
                `;
            } else if (field.type === 'password') {
                // 密码输入框添加显示/隐藏按钮
                inputHtml = `
                    <div class="password-wrapper">
                        <input type="${field.type}" id="${field.id}" class="form-field pr-10" placeholder="${field.placeholder}">
                        <i class="fa fa-eye password-toggle" title="显示密码" onclick="togglePasswordVisibility(this)"></i>
                    </div>
                `;
            } else {
                inputHtml = `<input type="${field.type}" id="${field.id}" class="form-field" placeholder="${field.placeholder}">`;
            }

            // 表单组模板
            html += `
                <div class="form-group">
                    <label for="${field.id}" class="text-sm font-medium text-gray-700">
                        ${field.label} ${field.required ? '<span class="text-error">*</span>' : ''}
                    </label>
                    ${inputHtml}
                    <p class="hidden text-error text-xs mt-1" id="error-${field.id}">${field.errorMsg}</p>
                </div>
            `;
        });

        elements.formFields.innerHTML = html;

        // 绑定验证事件
        fields.forEach(field => {
            const el = document.getElementById(field.id);
            if (el) {
                el.addEventListener('input', () => validateField(field));
                el.addEventListener('blur', () => validateField(field));
                // 设置回显值
                setFieldValue(field, echoData[field.id] || '');
            }
        });

        // 回显是否立即执行的勾选状态
        if (echoData.isExecute !== undefined) {
            elements.isExecute.checked = echoData.isExecute;
        }

        // 回显是否删除原有分组的勾选状态
        if (echoData.deleteFlag !== undefined) {
            elements.deleteFlag.checked = echoData.deleteFlag;
        }

        // 检查是否已填写必要信息，如果是则显示端口映射列表区域
        checkAndShowDstNatSection();
    };

    /**
     * 检查是否已填写必要信息，如果是则显示端口映射列表区域
     */
    const checkAndShowDstNatSection = () => {
        const type = elements.routerType.value;
        if (!type) return;

        const fields = CONFIG.FORM_FIELDS[type] || [];
        const requiredFields = fields.filter(field => field.required);

        // 检查所有必填字段是否已填写
        const allRequiredFilled = requiredFields.every(field => {
            const el = document.getElementById(field.id);
            return el && el.value.trim() !== '';
        });

        // 如果所有必填字段都已填写，显示端口映射列表区域
        if (allRequiredFilled) {
            elements.dstNatListSection.classList.remove('hidden');
        } else {
            elements.dstNatListSection.classList.add('hidden');
            // 隐藏列表容器
            elements.dstNatListContainer.classList.add('hidden');
        }
    };

    /**
     * 解析ResponseEntity格式的响应数据
     * @param {Response} response - fetch响应对象
     * @returns {Promise<object>} 解析后的响应数据
     */
    const parseResponseEntity = async (response) => {
        // 先获取响应文本（兼容非JSON格式）
        const responseText = await response.text();
        let data = {};
        console.log(responseText)
        // 尝试解析JSON
        try {
            if (responseText) {
                data = JSON.parse(responseText);
            }
        } catch (e) {
            // 非JSON格式直接封装为错误数据
            data = {
                success: false,
                message: `响应格式错误: ${responseText.substring(0, 100)}...`,
                status: response.status
            };
        }

        // 适配ResponseEntity的标准格式
        const responseBody = data.body || data.result || data.data || data;

        // 标准化响应格式
        return {
            success: responseBody.success ?? (response.status >= 200 && response.status < 300),
            message: responseBody.message || responseBody.msg || (response.ok ? '操作成功' : `请求失败: ${response.status}`),
            data: responseBody,
            status: response.status
        };
    };

    /**
     * 调用echo接口获取历史数据并回显
     * @param {string} routerType - 路由器类型
     */
    const fetchEchoData = async (routerType = 'ikuai') => {
        // 显示加载状态
        elements.formFields.innerHTML = `
            <div class="echo-loading">
                <i class="fa fa-spinner fa-spin mr-1"></i> 加载历史配置中...
            </div>
        `;

        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

            // 调用echo接口
            const response = await fetch(`${CONFIG.ECHO_API_URL}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                signal: controller.signal,
                credentials: 'include'
            });

            clearTimeout(timeoutId);

            // 解析ResponseEntity格式响应
            const parsedData = await parseResponseEntity(response);

            // 处理响应结果
            if (parsedData.success && parsedData.data) {
                // 处理IP地址列表格式标准化（支持字符串和数组两种格式）
                if (parsedData.data.blockAddress) {
                    let ips = parsedData.data.blockAddress;
                    console.log('原始IP配置数据:', ips);

                    let extractedIps = [];

                    // 处理数组格式
                    if (Array.isArray(ips)) {
                        console.log('检测到数组格式的IP数据');
                        extractedIps = ips.map(ip => ip.trim()).filter(ip => ip.length > 0);
                    }
                    // 处理字符串格式
                    else if (typeof ips === 'string') {
                        console.log('检测到字符串格式的IP数据');

                        // 处理逗号分隔的IP地址
                        if (ips.includes(',')) {
                            console.log('检测到逗号分隔的IP地址，进行格式转换');
                            extractedIps = ips.split(',')
                                .map(ip => ip.trim())
                                .filter(ip => ip.length > 0);
                        } else {
                            // 按换行符分割
                            extractedIps = ips.split('\n')
                                .map(ip => ip.trim())
                                .filter(ip => ip.length > 0);
                        }
                    }

                    // 去重处理
                    const uniqueIps = [...new Set(extractedIps)];
                    console.log('去重后的IP列表:', uniqueIps);

                    // 确保最终格式为每行一条（字符串格式用于页面显示）
                    const finalIps = uniqueIps.join('\n');
                    parsedData.data.blockAddress = finalIps;
                    console.log('最终标准化后的IP配置数据:', finalIps);
                }

                // 处理URL列表格式标准化（支持字符串和数组两种格式）
                if (parsedData.data.getIpUrls) {
                    let urls = parsedData.data.getIpUrls;
                    console.log('原始URL配置数据:', urls);

                    let extractedUrls = [];

                    // 处理数组格式
                    if (Array.isArray(urls)) {
                        console.log('检测到数组格式的URL数据');
                        extractedUrls = urls.map(url => url.trim()).filter(url => url.length > 0);
                    }
                    // 处理字符串格式
                    else if (typeof urls === 'string') {
                        console.log('检测到字符串格式的URL数据');

                        // 第一步：使用正则表达式提取所有有效的URL
                        const urlPattern = /https?:\/\/[^\s,]+/g;
                        const regexMatches = urls.match(urlPattern) || [];
                        console.log('正则提取到的URL列表:', regexMatches);

                        if (regexMatches.length > 0) {
                            extractedUrls = regexMatches;
                        } else {
                            // 第二步：如果没有提取到URL但原字符串不为空，尝试其他分割方式
                            if (urls.trim().length > 0) {
                                console.log('使用正则提取失败，尝试按逗号分割');
                                // 按逗号分割并清理
                                const splitUrls = urls.split(',')
                                    .map(url => url.trim())
                                    .filter(url => url.length > 0 && url.includes('http'));
                                extractedUrls = splitUrls;
                                console.log('按逗号分割后的URL列表:', splitUrls);
                            }
                        }

                        // 第三步：如果仍然没有URL，尝试直接使用原字符串
                        if (extractedUrls.length === 0 && urls.trim().length > 0) {
                            console.log('分割失败，尝试直接使用原字符串作为URL');
                            if (urls.trim().includes('http')) {
                                extractedUrls.push(urls.trim());
                            }
                        }
                    }

                    // 第四步：去重处理
                    const uniqueUrls = [...new Set(extractedUrls)];
                    console.log('去重后的URL列表:', uniqueUrls);

                    // 第五步：确保最终格式为每行一条（字符串格式用于页面显示）
                    const finalUrls = uniqueUrls.join('\n');
                    parsedData.data.getIpUrls = finalUrls;
                    console.log('最终标准化后的URL配置数据:', finalUrls);
                }

                // 有有效配置数据
                renderFields(routerType, parsedData.data);
                showResult(true, '已加载历史配置数据');
            } else {
                // 无配置数据
                renderFields(routerType);
                elements.formFields.insertAdjacentHTML('afterbegin', `
                    <div class="no-echo-data mb-4">未初始化配置</div>
                `);
                showResult(true, '暂无配置数据，请先填写并提交');
            }
        } catch (err) {
            // 处理网络错误/超时等异常
            renderFields(routerType);
            const errorMsg = err.name === 'AbortError' ? '请求超时，请检查网络' : `加载配置失败: ${err.message}`;
            elements.formFields.insertAdjacentHTML('afterbegin', `
                <div class="text-error text-xs text-center mb-4">
                    <i class="fa fa-exclamation-circle mr-1"></i> ${errorMsg}
                </div>
            `);
            showResult(false, errorMsg);
            console.error('Echo接口调用失败：', err);
        }
    };

    /**
     * 获取端口映射列表
     */
    const fetchDstNatList = async () => {
        // 验证必要字段
        const type = elements.routerType.value;
        const fields = CONFIG.FORM_FIELDS[type] || [];
        const requiredFields = fields.filter(field => field.required);

        let isValid = true;
        requiredFields.forEach(field => {
            if (!validateField(field)) isValid = false;
        });

        if (!isValid) {
            showResult(false, '请先填写并验证所有必填字段');
            const firstError = document.querySelector('[id^="error-"]:not(.hidden)');
            if (firstError) {
                firstError.scrollIntoView({behavior: 'smooth', block: 'center'});
            }
            return;
        }

        // 显示加载状态
        elements.dstNatListContainer.classList.remove('hidden');
        elements.dstNatLoading.classList.remove('hidden');
        elements.dstNatSummary.classList.add('hidden');
        elements.dstNatGroups.innerHTML = '';
        elements.dstNatEmpty.classList.add('hidden');
        elements.dstNatError.classList.add('hidden');

        // 禁用获取按钮
        elements.getDstNatListBtn.disabled = true;
        elements.getDstNatListBtn.querySelector('span').textContent = '获取中...';
        elements.getDstNatListBtn.querySelector('.loader').classList.remove('hidden');

        try {
            // 构建请求数据
            const requestData = {
                routerType: type,
                ...Object.fromEntries(
                    requiredFields.map(field => [field.id, getFieldValue(field)])
                )
            };

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

            // 调用API
            const response = await fetch(CONFIG.DST_NAT_LIST_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(requestData),
                signal: controller.signal,
                credentials: 'include'
            });

            clearTimeout(timeoutId);

            // 解析ResponseEntity格式响应
            const parsedData = await parseResponseEntity(response);

            // 隐藏加载状态
            elements.dstNatLoading.classList.add('hidden');

            if (parsedData.success && parsedData.data) {
                // 存储端口映射数据
                dstNatData = Array.isArray(parsedData.data) ? parsedData.data : [];
                console.log('获取到的端口映射数据:', dstNatData);

                if (dstNatData.length === 0) {
                    // 显示空状态
                    elements.dstNatEmpty.classList.remove('hidden');
                    showResult(true, '未找到端口映射规则');
                } else {
                    // 直接渲染所有数据，不进行分组
                    renderDstNatGroups(dstNatData);
                    showResult(true, `成功获取到 ${dstNatData.length} 条端口映射规则`);
                }
            } else {
                // 显示错误状态
                elements.dstNatError.classList.remove('hidden');
                elements.dstNatErrorMessage.textContent = parsedData.message || '获取端口映射列表失败';
                showResult(false, parsedData.message || '获取端口映射列表失败');
            }
        } catch (err) {
            // 处理网络错误/超时等异常
            elements.dstNatLoading.classList.add('hidden');
            elements.dstNatError.classList.remove('hidden');

            let errorMsg = '';
            if (err.name === 'AbortError') {
                errorMsg = '请求超时，请检查网络';
            } else if (err.message.includes('Failed to fetch')) {
                errorMsg = '接口访问失败，请检查后端服务是否启动或地址是否正确';
            } else {
                errorMsg = `获取失败：${err.message}`;
            }

            elements.dstNatErrorMessage.textContent = errorMsg;
            showResult(false, errorMsg);
            console.error('获取端口映射列表失败：', err);
        } finally {
            // 恢复按钮状态
            elements.getDstNatListBtn.disabled = false;
            elements.getDstNatListBtn.querySelector('span').textContent = '获取列表';
            elements.getDstNatListBtn.querySelector('.loader').classList.add('hidden');
        }
    };

    /**
     * 渲染端口映射列表
     * @param {Array} items - 端口映射数据数组
     */
    const renderDstNatGroups = (items) => {
        elements.dstNatGroups.innerHTML = '';

        // 显示汇总信息
        elements.dstNatSummary.classList.remove('hidden');
        updateSelectedCount();

        // 提取所有分组数据
        allGroups = [];
        items.forEach(item => {
            if (item.groupNameAll && Array.isArray(item.groupNameAll)) {
                item.groupNameAll.forEach(group => {
                    if (!allGroups.includes(group)) {
                        allGroups.push(group);
                    }
                });
            }
        });

        // 排序分组名称
        allGroups.sort();

        // 初始化分组选择状态
        dstNatGroupSelections.clear();
        items.forEach(item => {
            if (item.groupNameChoose && Array.isArray(item.groupNameChoose)) {
                dstNatGroupSelections.set(item.id, new Set(item.groupNameChoose));
            } else {
                dstNatGroupSelections.set(item.id, new Set());
            }
        });

        // 创建列表容器
        const listElement = document.createElement('div');
        listElement.className = 'dst-nat-list';

        // 添加每个端口映射项
        items.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = 'dst-nat-item';
            itemElement.dataset.id = item.id;
            itemElement.dataset.lanAddr = item.lan_addr || '';

            // lan_addr字段保持完整显示
            const lanAddrContent = item.lan_addr ?
                `<span class="dst-nat-lan-addr">${item.lan_addr}</span>` :
                '<span class="text-gray-400 text-sm">未知地址</span>';

            // 创建分组选择区域
            let groupsHtml = '';
            if (allGroups.length > 0) {
                // 获取当前项已选分组
                const selectedGroups = dstNatGroupSelections.get(item.id) || new Set();
                const selectedGroup = selectedGroups.size > 0 ? Array.from(selectedGroups)[0] : '';

                groupsHtml = `
                    <div class="relative">
                        <button type="button" class="dst-nat-group-dropdown text-xs border border-gray-300 rounded px-2 py-1 w-full max-w-[200px] text-left flex justify-between items-center"
                            data-id="${item.id}">
                            <span class="dst-nat-selected-text truncate">${selectedGroups.size > 0 ? Array.from(selectedGroups).join(', ') : '请选择分组'}</span>
                            <i class="fa fa-chevron-down text-xs ml-1"></i>
                        </button>
                        <div class="dst-nat-dropdown-menu hidden bg-white border border-gray-300 rounded shadow-lg max-h-40 overflow-y-auto">
                            <!-- 新增全选选项 -->
                            <label class="flex items-center px-2 py-1 hover:bg-gray-100 cursor-pointer block border-b border-gray-200">
                                <input type="checkbox"
                                    class="dst-nat-group-select-all w-3 h-3 mr-2"
                                    data-id="${item.id}">
                                <span class="font-medium text-primary">全选/取消全选</span>
                            </label>
                            ${allGroups.map(group => {
                    // 检查当前分组是否在已选择的分组中
                    const isSelected = selectedGroups.has(group);
                    return `
                                    <label class="flex items-center px-2 py-1 hover:bg-gray-100 cursor-pointer block">
                                        <input type="checkbox"
                                            class="dst-nat-group-checkbox w-3 h-3 mr-2"
                                            data-id="${item.id}"
                                            data-group="${group}"
                                            ${isSelected ? 'checked' : ''}>
                                        <span>${group}</span>
                                    </label>
                                `;
                }).join('')}
                        </div>
                    </div>
                `;
            } else {
                groupsHtml = '<div class="text-xs text-gray-500 mt-2">暂无可用分组</div>';
            }

            itemElement.innerHTML = `
                <input type="checkbox" class="dst-nat-checkbox" id="dst-nat-${item.id}" value="${item.id}">
                <div class="dst-nat-info flex-1">
                    <div class="w-full">
                        <div class="flex items-center w-full gap-16">
                            <div class="min-w-[120px] pl-4">${lanAddrContent}</div>
                            <div class="text-gray-400 text-sm flex-shrink-0">
                                <i class="fa fa-long-arrow-right"></i>
                            </div>
                            <div class="text-right flex-1">${groupsHtml}</div>
                        </div>
                    </div>
                </div>
            `;

            listElement.appendChild(itemElement);
        });

        elements.dstNatGroups.appendChild(listElement);

        // 绑定复选框事件
        bindDstNatCheckboxEvents();
        // 绑定分组复选框事件
        bindDstNatGroupCheckboxEvents();
    };

    /**
     * 绑定端口映射复选框事件
     */
    const bindDstNatCheckboxEvents = () => {
        // 为所有复选框绑定change事件
        document.querySelectorAll('.dst-nat-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const id = e.target.value;
                if (e.target.checked) {
                    selectedDstNatIds.add(id);
                } else {
                    selectedDstNatIds.delete(id);
                }
                updateSelectedCount();
            });
        });
    };

    /**
     * 绑定分组下拉菜单事件
     */
    const bindDstNatGroupCheckboxEvents = () => {
        // 为所有下拉按钮绑定点击事件
        document.querySelectorAll('.dst-nat-group-dropdown').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                // 切换当前下拉菜单
                const dropdownMenu = button.nextElementSibling;
                const isHidden = dropdownMenu.classList.contains('hidden');

                // 关闭所有其他下拉菜单
                document.querySelectorAll('.dst-nat-dropdown-menu').forEach(menu => {
                    menu.classList.add('hidden');
                });

                // 如果之前是隐藏的，则显示
                if (isHidden) {
                    dropdownMenu.classList.remove('hidden');
                }
            });
        });

        // 为所有分组复选框绑定change事件
        document.querySelectorAll('.dst-nat-group-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const id = e.target.dataset.id;
                const group = e.target.dataset.group;

                // 获取当前项的分组选择状态
                let selectedGroups = dstNatGroupSelections.get(id);
                if (!selectedGroups) {
                    selectedGroups = new Set();
                    dstNatGroupSelections.set(id, selectedGroups);
                }

                // 更新分组选择状态
                if (e.target.checked) {
                    selectedGroups.add(group);
                } else {
                    selectedGroups.delete(group);
                }

                // 【修改】只要用户与分组复选框有交互（无论是选择还是取消选择），就自动勾选前面的单选框
                const mainCheckbox = document.getElementById(`dst-nat-${id}`);
                if (mainCheckbox && !mainCheckbox.checked) {
                    mainCheckbox.checked = true;
                    selectedDstNatIds.add(id);
                    updateSelectedCount();
                }

                // 更新全选复选框的状态
                updateSelectAllCheckbox(id);

                // 更新显示文本
                updateSelectedText(id);
            });
        });

        // 为全选复选框绑定change事件
        document.querySelectorAll('.dst-nat-group-select-all').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const id = e.target.dataset.id;
                const isChecked = e.target.checked;

                // 获取当前项的所有分组复选框
                const groupCheckboxes = document.querySelectorAll(`.dst-nat-group-checkbox[data-id="${id}"]`);

                // 获取当前项的分组选择状态
                let selectedGroups = dstNatGroupSelections.get(id);
                if (!selectedGroups) {
                    selectedGroups = new Set();
                    dstNatGroupSelections.set(id, selectedGroups);
                }

                // 更新所有分组复选框的状态
                groupCheckboxes.forEach(groupCheckbox => {
                    groupCheckbox.checked = isChecked;
                    const group = groupCheckbox.dataset.group;

                    if (isChecked) {
                        selectedGroups.add(group);
                    } else {
                        selectedGroups.delete(group);
                    }
                });

                // 自动勾选前面的单选框
                const mainCheckbox = document.getElementById(`dst-nat-${id}`);
                if (mainCheckbox && !mainCheckbox.checked) {
                    mainCheckbox.checked = true;
                    selectedDstNatIds.add(id);
                    updateSelectedCount();
                }

                // 更新显示文本
                updateSelectedText(id);
            });
        });

        // 更新全选复选框的状态
        const updateSelectAllCheckbox = (id) => {
            const selectAllCheckbox = document.querySelector(`.dst-nat-group-select-all[data-id="${id}"]`);
            if (!selectAllCheckbox) return;

            const groupCheckboxes = document.querySelectorAll(`.dst-nat-group-checkbox[data-id="${id}"]`);
            const checkedCheckboxes = document.querySelectorAll(`.dst-nat-group-checkbox[data-id="${id}"]:checked`);

            selectAllCheckbox.checked = groupCheckboxes.length > 0 && groupCheckboxes.length === checkedCheckboxes.length;
            selectAllCheckbox.indeterminate = checkedCheckboxes.length > 0 && checkedCheckboxes.length < groupCheckboxes.length;
        };

        // 点击页面其他地方关闭下拉菜单
        document.addEventListener('click', () => {
            document.querySelectorAll('.dst-nat-dropdown-menu').forEach(menu => {
                menu.classList.add('hidden');
            });
        });

        // 阻止下拉菜单内部点击事件冒泡
        document.querySelectorAll('.dst-nat-dropdown-menu').forEach(menu => {
            menu.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        });
    };

    /**
     * 更新选中文本显示
     * @param {string} id - 端口映射项ID
     */
    const updateSelectedText = (id) => {
        // 直接从DOM中获取当前选中的分组，确保与用户界面保持一致
        const itemElement = document.querySelector(`.dst-nat-item[data-id="${id}"]`);
        if (!itemElement) return;

        const checkedBoxes = itemElement.querySelectorAll('.dst-nat-group-checkbox:checked');
        const selectedGroups = Array.from(checkedBoxes).map(checkbox => checkbox.dataset.group);

        const dropdownButton = itemElement.querySelector('.dst-nat-group-dropdown');
        if (dropdownButton) {
            const selectedTextElement = dropdownButton.querySelector('.dst-nat-selected-text');
            if (selectedGroups.length > 0) {
                selectedTextElement.textContent = `${selectedGroups.join(', ')} ✓`;
            } else {
                selectedTextElement.textContent = '请选择分组';
            }
        }
    };

    /**
     * 更新选中数量显示
     */
    const updateSelectedCount = () => {
        elements.selectedCount.textContent = selectedDstNatIds.size;
    };

    /**
     * 处理表单提交 - 已修改为直接传递整个表单的所有字段
     * @param {Event} e - 提交事件
     */
    const handleSubmit = async (e) => {
        e.preventDefault();
        let isValid = true;
        const type = elements.routerType.value;
        const isExecute = elements.isExecute.checked;

        // 重置所有错误提示
        document.querySelectorAll('[id^="error-"]').forEach(el => el.classList.add('hidden'));

        // 验证路由器类型
        if (!type) {
            elements.errorRouterType.classList.remove('hidden');
            isValid = false;
        }

        // 验证表单字段
        if (isValid) {
            const fields = CONFIG.FORM_FIELDS[type] || [];
            fields.forEach(field => {
                if (!validateField(field)) isValid = false;
            });
        }

        // 验证失败处理
        if (!isValid) {
            const firstError = document.querySelector('[id^="error-"]:not(.hidden)');
            if (firstError) {
                firstError.scrollIntoView({behavior: 'smooth', block: 'center'});
            }
            return;
        }

        // 构建提交数据 - 直接传递整个表单的所有字段
        const submitData = {
            routerType: type,
            isExecute: isExecute,
            deleteFlag: elements.deleteFlag.checked,
            dstNatIds: Array.from(selectedDstNatIds), // 传递选中的端口映射ID
            // 直接添加所有表单字段
            userName: getFieldValue({id: 'userName'}),
            password: getFieldValue({id: 'password'}),
            ikuaiIp: getFieldValue({id: 'ikuaiIp'}),
            blockAddress: getFieldValue({id: 'blockAddress'}),
            getIpUrls: getFieldValue({id: 'getIpUrls'})
        };

        // 特殊处理IP地址列表和URL列表，转换为数组格式
        if (submitData.blockAddress) {
            // 清理空行和首尾空格，确保每行一条
            let cleanedItems = submitData.blockAddress.split('\n')
                .map(item => item.trim())
                .filter(item => item.length > 0);

            // 检查是否有项目中包含逗号，如果有则分割处理
            const itemsWithCommas = cleanedItems.filter(item => item.includes(','));
            if (itemsWithCommas.length > 0) {
                // 处理包含逗号的项目
                const expandedItems = [];
                cleanedItems.forEach(item => {
                    if (item.includes(',')) {
                        // 分割并清理每个项目
                        item.split(',').forEach(splitItem => {
                            const trimmed = splitItem.trim();
                            if (trimmed.length > 0) {
                                expandedItems.push(trimmed);
                            }
                        });
                    } else {
                        expandedItems.push(item);
                    }
                });
                cleanedItems = expandedItems;
            }

            // 对IP地址列表转换为数组格式以匹配后端API要求
            submitData.blockAddress = cleanedItems;
            console.log('IP配置转换为数组格式:', submitData.blockAddress);
        }

        if (submitData.getIpUrls) {
            // 清理空行和首尾空格，确保每行一条
            let cleanedItems = submitData.getIpUrls.split('\n')
                .map(item => item.trim())
                .filter(item => item.length > 0);

            // 检查是否有项目中包含逗号，如果有则分割处理
            const itemsWithCommas = cleanedItems.filter(item => item.includes(','));
            if (itemsWithCommas.length > 0) {
                // 处理包含逗号的项目
                const expandedItems = [];
                cleanedItems.forEach(item => {
                    if (item.includes(',')) {
                        // 分割并清理每个项目
                        item.split(',').forEach(splitItem => {
                            const trimmed = splitItem.trim();
                            if (trimmed.length > 0) {
                                expandedItems.push(trimmed);
                            }
                        });
                    } else {
                        expandedItems.push(item);
                    }
                });
                cleanedItems = expandedItems;
            }

            // 对URL列表转换为数组格式以匹配后端API要求
            submitData.getIpUrls = cleanedItems;
            console.log('URL配置转换为数组格式:', submitData.getIpUrls);
        }

        // 仅开发环境打印提交数据
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log('提交数据：', submitData);
        }

        try {
            // 提交状态处理
            elements.submitBtn.disabled = true;
            elements.submitBtn.querySelector('span').textContent = '提交中...';
            elements.loader.classList.remove('hidden');

            // 调用API
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

            const response = await fetch(CONFIG.API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(submitData),
                signal: controller.signal,
                credentials: 'include'
            });

            clearTimeout(timeoutId);

            // 解析ResponseEntity格式响应
            const parsedData = await parseResponseEntity(response);

            // 显示结果
            let successMsg = '';
            if (parsedData.success) {
                const baseMsg = parsedData.message || '操作成功';
                if (isExecute) {
                    successMsg = `${baseMsg}（已立即执行白名单更新）`;
                } else {
                    successMsg = `${baseMsg}（配置已保存，系统将每3天自动执行一次IP白名单更新）`;
                }
            } else {
                successMsg = parsedData.message || `操作失败[${parsedData.status}]`;
            }

            showResult(parsedData.success, successMsg);

            // 提交成功后重新拉取echo数据
            if (parsedData.success) {
                await fetchEchoData(type);
            }

        } catch (err) {
            let errorMsg = '';
            if (err.name === 'AbortError') {
                errorMsg = '请求超时，请检查网络或服务器状态';
            } else if (err.message.includes('Failed to fetch')) {
                errorMsg = '接口访问失败，请检查后端服务是否启动或地址是否正确';
            } else {
                errorMsg = `提交失败：${err.message}`;
            }
            showResult(false, errorMsg);
            // 仅开发环境打印错误详情
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.error('提交错误：', err);
            }
        } finally {
            // 恢复按钮状态
            elements.submitBtn.disabled = false;
            elements.submitBtn.querySelector('span').textContent = '提交';
            elements.loader.classList.add('hidden');
        }
    };

    /**
     * 处理表单重置
     */
    const handleReset = (e) => {
        e.preventDefault();
        elements.result.classList.add('hidden');
        elements.errorRouterType.classList.add('hidden');
        elements.routerType.value = 'ikuai';
        elements.deleteFlag.checked = false; // 重置删除原有分组选项

        // 清空选中的端口映射ID
        selectedDstNatIds.clear();

        // 隐藏端口映射列表区域
        elements.dstNatListSection.classList.add('hidden');
        elements.dstNatListContainer.classList.add('hidden');

        // 重置后重新拉取echo数据
        fetchEchoData('ikuai');
    };

    /**
     * 处理配置上传
     */
    const handleUpload = async () => {
        try {
            // 触发文件选择
            elements.fileInput.click();
        } catch (err) {
            showResult(false, `上传失败：${err.message}`);
            console.error('上传错误：', err);
        }
    };

    /**
     * 处理文件选择
     */
    const handleFileSelect = async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        try {
            // 显示上传状态
            elements.uploadBtn.disabled = true;
            elements.uploadBtn.querySelector('span').textContent = '上传中...';
            elements.uploadBtn.querySelector('.loader').classList.remove('hidden');

            const formData = new FormData();
            formData.append('file', file);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

            // 调用上传API
            const response = await fetch(CONFIG.UPLOAD_API_URL, {
                method: 'POST',
                body: formData,
                signal: controller.signal,
                credentials: 'include'
            });

            clearTimeout(timeoutId);

            // 解析响应
            const parsedData = await parseResponseEntity(response);

            if (parsedData.success) {
                showResult(true, '配置文件上传成功！');
                // 重新加载配置
                await fetchEchoData(elements.routerType.value);
            } else {
                showResult(false, `上传失败：${parsedData.message}`);
            }
        } catch (err) {
            let errorMsg = '';
            if (err.name === 'AbortError') {
                errorMsg = '上传超时，请检查网络';
            } else {
                errorMsg = `上传失败：${err.message}`;
            }
            showResult(false, errorMsg);
            console.error('上传错误：', err);
        } finally {
            // 恢复按钮状态
            elements.uploadBtn.disabled = false;
            elements.uploadBtn.querySelector('span').textContent = '上传配置';
            elements.uploadBtn.querySelector('.loader').classList.add('hidden');
            // 清空文件输入
            elements.fileInput.value = '';
        }
    };

    /**
     * 批量设置分组 - 已修改：直接读取DOM元素状态
     */
    const handleBatchUpdateGroups = async () => {
        // 检查是否有选中的端口映射项
        if (selectedDstNatIds.size === 0) {
            showResult(false, '请先选择需要设置分组的端口映射项');
            return;
        }

        // 构建更新数据
        const updateData = [];

        selectedDstNatIds.forEach(id => {
            // 1. 获取该行对应的DOM元素
            const itemElement = document.querySelector(`.dst-nat-item[data-id="${id}"]`);

            if (itemElement) {
                const lanAddr = itemElement.dataset.lanAddr;

                // 2. 【核心修改】直接查询该行下拉框中所有状态为 checked 的复选框
                // 这样无论数据是初始化的，还是用户手动修改的，只要页面上勾选了，就会被获取
                const checkedBoxes = itemElement.querySelectorAll('.dst-nat-group-checkbox:checked');

                // 3. 提取所有选中复选框的 group 值
                const currentSelectedGroups = Array.from(checkedBoxes).map(checkbox => checkbox.dataset.group);

                // 4. 组装数据
                if (lanAddr) {
                    updateData.push({
                        id: id, // 增加id字段
                        lan_addr: lanAddr,
                        groupNames: currentSelectedGroups // 使用直接从界面读取的数据
                    });
                }
            }
        });

        // 仅开发环境打印，用于调试确认数据是否正确
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log('批量提交的分组数据(所见即所得):', updateData);
        }

        // 检查是否有有效的更新数据
        if (updateData.length === 0) {
            showResult(false, '未能获取到有效的数据，请刷新重试');
            return;
        }

        // 显示加载状态
        elements.batchUpdateGroupsBtn.disabled = true;
        elements.batchUpdateGroupsBtn.querySelector('span').textContent = '设置中...';
        elements.batchUpdateGroupsBtn.querySelector('.loader').classList.remove('hidden');

        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

            // 调用API
            const response = await fetch(CONFIG.UPDATE_DST_NAT_LIST_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(updateData),
                signal: controller.signal,
                credentials: 'include'
            });

            clearTimeout(timeoutId);

            // 解析ResponseEntity格式响应
            const parsedData = await parseResponseEntity(response);

            // 显示结果
            if (parsedData.success) {
                showResult(true, `成功设置 ${updateData.length} 个端口映射项的分组`);
                // 重新获取端口映射列表以更新显示
                await fetchDstNatList();
            } else {
                showResult(false, parsedData.message || '设置分组失败');
            }
        } catch (err) {
            let errorMsg = '';
            if (err.name === 'AbortError') {
                errorMsg = '请求超时，请检查网络';
            } else if (err.message.includes('Failed to fetch')) {
                errorMsg = '接口访问失败，请检查后端服务是否启动或地址是否正确';
            } else {
                errorMsg = `设置分组失败：${err.message}`;
            }
            showResult(false, errorMsg);
            console.error('批量设置分组失败：', err);
        } finally {
            // 恢复按钮状态
            elements.batchUpdateGroupsBtn.disabled = false;
            elements.batchUpdateGroupsBtn.querySelector('span').textContent = '批量设置分组';
            elements.batchUpdateGroupsBtn.querySelector('.loader').classList.add('hidden');
        }
    };

    /**
     * 处理配置下载
     */
    const handleDownload = async () => {
        try {
            // 显示下载状态
            elements.downloadBtn.disabled = true;
            elements.downloadBtn.querySelector('span').textContent = '下载中...';
            elements.downloadBtn.querySelector('.loader').classList.remove('hidden');

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

            // 调用下载API
            const response = await fetch(CONFIG.DOWNLOAD_API_URL, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                },
                signal: controller.signal,
                credentials: 'include'
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                throw new Error(`下载失败：${response.status} ${response.statusText}`);
            }

            // 获取文件名
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'router-config.json';
            if (contentDisposition) {
                const match = contentDisposition.match(/filename="?([^"]*)"?/);
                if (match && match[1]) {
                    filename = match[1];
                }
            }

            // 获取文件内容
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);

            // 创建下载链接
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showResult(true, '配置文件下载成功！');
        } catch (err) {
            let errorMsg = '';
            if (err.name === 'AbortError') {
                errorMsg = '下载超时，请检查网络';
            } else {
                errorMsg = `下载失败：${err.message}`;
            }
            showResult(false, errorMsg);
            console.error('下载错误：', err);
        } finally {
            // 恢复按钮状态
            elements.downloadBtn.disabled = false;
            elements.downloadBtn.querySelector('span').textContent = '下载配置';
            elements.downloadBtn.querySelector('.loader').classList.add('hidden');
        }
    };

    /**
     * 切换全选/取消全选端口映射
     */
    const toggleSelectAllDstNat = () => {
        const allCheckboxes = document.querySelectorAll('.dst-nat-checkbox');
        const isAllSelected = Array.from(allCheckboxes).every(checkbox => checkbox.checked);

        if (isAllSelected) {
            // 当前是全选状态，切换为取消全选
            allCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            selectedDstNatIds.clear();
            // 更新按钮状态
            elements.toggleSelectAllBtn.querySelector('i').className = 'fa fa-square-o';
            elements.toggleSelectAllBtn.querySelector('span').textContent = '全选';
        } else {
            // 当前不是全选状态，切换为全选
            allCheckboxes.forEach(checkbox => {
                checkbox.checked = true;
                selectedDstNatIds.add(checkbox.value);
            });
            // 更新按钮状态
            elements.toggleSelectAllBtn.querySelector('i').className = 'fa fa-check-square-o';
            elements.toggleSelectAllBtn.querySelector('span').textContent = '取消全选';
        }

        updateSelectedCount();
    };

    /**
     * 初始化函数
     */
    const init = () => {
        // 初始加载echo数据
        fetchEchoData(elements.routerType.value);

        // 绑定事件
        elements.routerType.addEventListener('change', (e) => {
            fetchEchoData(e.target.value);
        });
        elements.form.addEventListener('submit', handleSubmit);
        elements.form.addEventListener('reset', handleReset);

        // 绑定上传下载事件
        elements.uploadBtn.addEventListener('click', handleUpload);
        elements.downloadBtn.addEventListener('click', handleDownload);
        elements.fileInput.addEventListener('change', handleFileSelect);

        // 新增：绑定端口映射相关事件
        elements.getDstNatListBtn.addEventListener('click', fetchDstNatList);
        elements.toggleSelectAllBtn.addEventListener('click', toggleSelectAllDstNat);
        elements.batchUpdateGroupsBtn.addEventListener('click', handleBatchUpdateGroups);

        // 监听表单字段变化，检查是否显示端口映射列表区域
        document.addEventListener('input', debounce((e) => {
            if (e.target.form === elements.form) {
                checkAndShowDstNatSection();
            }
        }, 300));

        // 窗口大小变化防抖
        window.addEventListener('resize', debounce(() => {
            fetchEchoData(elements.routerType.value);
        }, 500));

        // 挂载密码切换函数
        window.togglePasswordVisibility = togglePasswordVisibility;

        // 开发环境调试信息
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log('表单初始化完成，当前接口地址：', CONFIG.API_URL);
        }
    };

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>